# 脆弱性を持ったサーバをたてる

## 機能
- ユーザー作成
  - `name`と`password`で作成
  - 通常`password`を平文でDBに保存することはしないが、今回は簡易実装なので平文でDBへ保存
- サインイン
  - `name`と`password`でサインイン
  - **SQLインジェクション対策をしたモードとしていないモードがある**
- 登録ユーザー情報一覧取得
  - デバッグ用にDB内に登録されているユーザー情報を全て取得する

## エンドポイント
### GET /ok
サーバが正常に起動しているか確認する
#### パラメータ
なし
#### 200レスポンス
`OK`という文字列が返ってくる

### GET /users
DBに登録されているユーザー情報を全てjson形式で取得する
#### パラメータ
なし
#### 200レスポンス
以下のようなjson形式のデータ
```json
{
  "users": [
    {
      "id": Number,
      "name": String,
      "password": String
    }
  ]
}
```
### POST /users
ユーザーを作成する
#### パラメータ
**body**  
以下のようなjson形式のデータ
```json
{
  "name": String,
  "password": String
}
```
#### 200レスポンス
`completed create user`という文字列が返ってくる

### POST /signIn
`name`と`password`を使用しサインインする
#### パラメータ
**queryパラメータ**
- `isSafe: bool`
  - `false`を指定するとSQLインジェクション可能なメソッドを使用しサインイン処理を行う
  - デフォルト値は`true`である  

**body**  
以下のようなjson形式のデータ
```json
{
  "name": String,
  "password": String
}
```
#### 200レスポンス
サインインに成功した場合、以下のようなjson形式でサインインに成功したユーザー情報が返される
```json
{
  "id": Number,
  "name": String,
  "password": String
}
```
サインインに失敗した(該当ユーザーが存在しない)場合、`null`が返される

## 実際に行ったSQLインジェクション対策
**ステークホルダを使用する**  
ステークホルダを使用することで外部から与えられてものを全体で文字列として扱うことができるようになる  
https://github.com/shunsuke-tamura/vulnerability-demo/blob/master/be/src/models/user.go#L43-L51

## 動作確認
### サーバの起動
1. PCに`Git`と`Docker`をインストールする
2. 以下のコマンドを実行する
  ```bash
  git clone https://github.com/shunsuke-tamura/vulnerability-demo.git
  cd vulnerability-demo/be
  touch .env
  <--.env を作成-->
  docker run -v `pwd`/src/db/migrations:/migrations --network host migrate/migrate -path=/migrations -database 'mysql://root:password@tcp(localhost:3306)/vulnerability' up
  docker compose up --build -d db
  docker compose up server
  ```
3. `http://localhost:8080`にサーバが起動する
### 各エンドポイントの動作確認
各エンドポイントに対して`curl`を叩いて検証する  
#### GET /ok
**実行コマンド**  
```bash
curl http://localhost:8080/ok
```
**結果**  
![](docs/images/1_ok.png)  

#### GET /users
**実行コマンド**  
```bash
curl http://localhost:8080/users
```
**結果**  
![](docs/images/2_get_users.png)  

#### POST /users
**実行コマンド**  
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"test", "password":"test"}' http://localhost:8080/users
```
**結果**  
![](docs/images/3_post_users.png)  
正常に終了したようなので、再びユーザー一覧を取得すると、しっかりと追加されていることが確認できる  
![](docs/images/4_after_get_users.png)  

#### POST /signIn
##### SQLインジェクション対策済み
**サインイン成功**  
**実行コマンド**  
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"test", "password":"test"}' "http://localhost:8080/signIn?isSafe=true"
```
**結果**  
![](docs/images/5_signin_safe_success.png)

**サインイン失敗**  
**実行コマンド**  
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"test", "password":"hoge"}' "http://localhost:8080/signIn?isSafe=true"
```
**結果**  
![](docs/images/6_signin_safe_fatal.png)

**SQLインジェクション**  
**実行コマンド**  
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"", "password":"\" and \"1\"=\"1"}' "http://localhost:8080/signIn?isSafe=true"
```
**結果**  
![](docs/images/7_signin_safe_attack.png)


##### 脆弱性あり
**サインイン成功**
**実行コマンド**
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"test", "password":"test"}' "http://localhost:8080/signIn?isSafe=false"
```
**結果**
![](docs/images/8_signin_unsafe_success.png)

**サインイン失敗**
**実行コマンド**
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"test", "password":"hoge"}' "http://localhost:8080/signIn?isSafe=false"
```
**結果**
![](docs/images/9_signin_unsafe_fatal.png)

**SQLインジェクション**
**実行コマンド**
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"", "password":"\" or \"1\"=\"1"}' "http://localhost:8080/signIn?isSafe=false"
```
**結果**
![](docs/images/10_signin_unsafe_attack.png)
実行されるクエリをログに出力してみると、不正なクエリが実行されていることがわかる
![](docs/images/11_log.png)
